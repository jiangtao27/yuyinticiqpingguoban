<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>平滑提词器</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        :root {
            --font-size: 36px;
            --line-height: 1.6;
        }

        html, body {
            width: 100%;
            height: 100%;
            background: #000;
            color: #fff;
            font-family: -apple-system, BlinkMacSystemFont, "SF Pro Display", sans-serif;
            overflow: hidden;
            position: fixed;
        }

        /* 启动页 */
        .start {
            position: fixed;
            inset: 0;
            background: #000;
            padding: 40px 30px;
            z-index: 1000;
            display: flex;
            flex-direction: column;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
        }

        .start.hidden { display: none; }

        h1 {
            font-size: 28px;
            font-weight: 600;
            margin-bottom: 8px;
            color: #fff;
            margin-top: env(safe-area-inset-top);
        }

        .sub {
            color: #666;
            font-size: 15px;
            margin-bottom: 30px;
        }

        textarea {
            width: 100%;
            flex: 1;
            background: #111;
            border: 1px solid #333;
            border-radius: 12px;
            padding: 20px;
            color: #fff;
            font-size: 16px;
            line-height: 1.5;
            resize: none;
            margin-bottom: 15px;
            -webkit-user-select: text;
            font-family: inherit;
        }

        .btn {
            width: 100%;
            padding: 16px;
            background: #fff;
            color: #000;
            border: none;
            border-radius: 12px;
            font-size: 17px;
            font-weight: 600;
            cursor: pointer;
            margin-bottom: 10px;
            font-family: inherit;
        }

        .btn.secondary {
            background: #333;
            color: #fff;
        }

        /* 提词器主体 */
        .prompter {
            display: none;
            position: fixed;
            inset: 0;
            background: #000;
            overflow: hidden;
            touch-action: pan-y;
        }

        .prompter.active {
            display: block;
        }

        /* 滚动轨道 */
        .track {
            position: absolute;
            width: 100%;
            padding: 0 40px;
            top: 0;
            left: 0;
            /* 关键：平滑过渡，不要猛跳 */
            transition: transform 0.8s cubic-bezier(0.25, 0.1, 0.25, 1);
            will-change: transform;
        }

        .line {
            width: 100%;
            text-align: center;
            font-size: var(--font-size);
            line-height: var(--line-height);
            color: #fff;
            padding: 15px 0;
            margin: 0;
            font-weight: 400;
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: auto;
            overflow: visible;
            word-wrap: break-word;
            word-break: break-all;
        }

        .line.active {
            transform: scale(1.05);
            font-weight: 600;
            text-shadow: 0 0 10px rgba(255,255,255,0.3);
            color: #fff;
        }

        /* 设置按钮 */
        .fab {
            position: absolute;
            bottom: 30px;
            right: 30px;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: rgba(255,255,255,0.1);
            backdrop-filter: blur(10px);
            border: none;
            color: rgba(255,255,255,0.5);
            font-size: 20px;
            z-index: 100;
            opacity: 0;
            transition: opacity 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
        }

        .fab.show {
            opacity: 1;
        }

        /* 设置面板 */
        .settings {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: rgba(20,20,20,0.98);
            border-radius: 20px 20px 0 0;
            padding: 25px;
            padding-bottom: calc(25px + env(safe-area-inset-bottom));
            transform: translateY(100%);
            transition: transform 0.3s;
            z-index: 200;
            max-height: 85vh;
            overflow-y: auto;
        }

        .settings.open {
            transform: translateY(0);
        }

        .setting-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            padding-bottom: 15px;
            border-bottom: 1px solid #333;
        }

        .setting-title {
            font-size: 20px;
            font-weight: 600;
            color: #fff;
        }

        .btn-close-x {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: #333;
            border: none;
            color: #fff;
            font-size: 18px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .setting-row {
            margin-bottom: 30px;
        }

        .label {
            display: flex;
            justify-content: space-between;
            font-size: 15px;
            color: #888;
            margin-bottom: 12px;
        }

        .value {
            color: #fff;
            font-weight: 600;
        }

        .slider {
            width: 100%;
            -webkit-appearance: none;
            height: 6px;
            border-radius: 3px;
            background: rgba(255,255,255,0.2);
            outline: none;
        }

        .slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            background: #fff;
            cursor: pointer;
            box-shadow: 0 2px 8px rgba(0,0,0,0.3);
        }

        .setting-buttons {
            display: flex;
            gap: 12px;
            margin-top: 30px;
        }

        .btn-half {
            flex: 1;
            padding: 16px;
            border: none;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
        }

        .btn-cancel {
            background: #333;
            color: #fff;
        }

        .btn-save {
            background: #fff;
            color: #000;
        }

        .overlay {
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.5);
            opacity: 0;
            pointer-events: none;
            z-index: 150;
        }

        .overlay.show {
            opacity: 1;
            pointer-events: auto;
        }

        /* 提示 */
        .hint {
            position: absolute;
            top: 80px;
            left: 50%;
            transform: translateX(-50%);
            color: rgba(255,255,255,0.3);
            font-size: 14px;
            opacity: 0;
            transition: opacity 0.3s;
            pointer-events: none;
            text-align: center;
        }

        .hint.show {
            opacity: 1;
        }
    </style>
</head>
<body>

    <!-- 启动页 -->
    <div class="start" id="start">
        <h1>平滑提词器</h1>
        <div class="sub">匀速滚动 · 平滑翻页 · 不再猛跳</div>
        <textarea id="input" placeholder="粘贴台词，每行一句...">欢迎使用平滑提词器
现在滚动会非常平滑
不会再猛的一下往上跳
而是匀速丝滑移动
像电影字幕一样优雅
上下滑动屏幕翻页
双指可以缩放字体
点击右下角设置按钮
可以调节各种参数
祝你演讲成功</textarea>
        <button class="btn" onclick="start()">开始演讲</button>
        <button class="btn secondary" onclick="startFullscreen()">全屏模式</button>
    </div>

    <!-- 提词器 -->
    <div class="prompter" id="prompter">
        <div class="track" id="track"></div>
        
        <div class="hint" id="hint">上滑下一句 · 下滑上一句</div>
        
        <button class="fab" id="fab" onclick="openSettings()">⚙️</button>
        
        <div class="overlay" id="overlay" onclick="closeSettings()"></div>
        
        <!-- 设置面板 - 带明确取消按钮 -->
        <div class="settings" id="settings">
            <div class="setting-header">
                <div class="setting-title">设置</div>
                <button class="btn-close-x" onclick="closeSettings()">✕</button>
            </div>

            <div class="setting-row">
                <div class="label">
                    <span>字体大小</span>
                    <span class="value" id="fontVal">36px</span>
                </div>
                <input type="range" class="slider" min="20" max="72" value="36" id="fontSlider" oninput="updateFont(this.value)">
            </div>

            <div class="setting-row">
                <div class="label">
                    <span>行间距</span>
                    <span class="value" id="lineVal">1.6</span>
                </div>
                <input type="range" class="slider" min="10" max="30" value="16" id="lineSlider" oninput="updateLine(this.value)">
            </div>

            <div class="setting-row">
                <div class="label">
                    <span>滚动平滑度</span>
                    <span class="value" id="smoothVal">标准</span>
                </div>
                <input type="range" class="slider" min="3" max="10" value="8" id="smoothSlider" oninput="updateSmooth(this.value)">
                <div style="display: flex; justify-content: space-between; font-size: 12px; color: #666; margin-top: 5px;">
                    <span>快</span>
                    <span>慢而平滑</span>
                </div>
            </div>

            <!-- 明确的取消和确认按钮 -->
            <div class="setting-buttons">
                <button class="btn-half btn-cancel" onclick="closeSettings()">取消</button>
                <button class="btn-half btn-save" onclick="saveSettings()">完成</button>
            </div>
        </div>
    </div>

    <script>
        let lines = [];
        let lineEls = [];
        let current = 0;
        let targetY = 0;
        let currentY = 0;
        let animationId = null;
        let transitionDuration = 0.8; // 滚动动画时长（秒）
        let isTouching = false;
        let startY = 0;
        let startTime = 0;

        // 初始化
        function start() {
            const text = document.getElementById('input').value.trim();
            if (!text) return alert('请输入台词');
            
            lines = text.split('\n').filter(l => l.trim());
            document.getElementById('start').classList.add('hidden');
            document.getElementById('prompter').classList.add('active');
            
            init();
            
            setTimeout(() => {
                document.getElementById('fab').classList.add('show');
                document.getElementById('hint').classList.add('show');
                setTimeout(() => document.getElementById('hint').classList.remove('show'), 3000);
            }, 100);
        }

        function startFullscreen() {
            start();
            setTimeout(() => {
                const el = document.documentElement;
                if (el.requestFullscreen) el.requestFullscreen();
                else if (el.webkitRequestFullscreen) el.webkitRequestFullscreen();
            }, 100);
        }

        function init() {
            const track = document.getElementById('track');
            track.innerHTML = '';
            lineEls = [];
            
            lines.forEach((line) => {
                const div = document.createElement('div');
                div.className = 'line';
                div.textContent = line;
                track.appendChild(div);
                lineEls.push(div);
            });

            // 计算位置
            setTimeout(() => {
                goTo(0, false);
            }, 50);
        }

        // 核心：平滑滚动到指定行，不猛跳
        function goTo(index, animate = true) {
            if (index < 0 || index >= lines.length) return;
            
            current = index;
            
            // 计算目标位置（当前行在屏幕40%位置，中央偏上）
            const viewportHeight = window.innerHeight;
            const focusLine = lineEls[index];
            const lineHeight = focusLine.offsetHeight;
            const lineTop = focusLine.offsetTop;
            
            // 目标：让当前行的顶部位于视口40%处
            targetY = -(lineTop - viewportHeight * 0.4 + lineHeight/2);
            
            if (!animate) {
                currentY = targetY;
                updatePosition();
            } else {
                // 使用CSS transition平滑移动，不猛跳
                const track = document.getElementById('track');
                track.style.transition = `transform ${transitionDuration}s cubic-bezier(0.25, 0.1, 0.25, 1)`;
                updatePosition();
            }
            
            // 更新高亮
            lineEls.forEach((el, i) => {
                el.classList.toggle('active', i === index);
            });
        }

        function updatePosition() {
            document.getElementById('track').style.transform = `translateY(${targetY}px)`;
        }

        // 手势控制 - 上下滑动翻页
        function setupGestures() {
            const stage = document.getElementById('prompter');
            
            stage.addEventListener('touchstart', (e) => {
                startY = e.touches[0].clientY;
                startTime = Date.now();
                isTouching = true;
                
                // 触摸时暂停CSS过渡，跟随手指
                document.getElementById('track').style.transition = 'none';
            }, { passive: true });

            stage.addEventListener('touchmove', (e) => {
                if (!isTouching) return;
                
                const currentY_touch = e.touches[0].clientY;
                const deltaY = startY - currentY_touch;
                
                // 跟随手指移动（阻尼效果）
                const tempY = targetY - deltaY * 0.5;
                document.getElementById('track').style.transform = `translateY(${tempY}px)`;
            }, { passive: true });

            stage.addEventListener('touchend', (e) => {
                if (!isTouching) return;
                isTouching = false;
                
                const endY = e.changedTouches[0].clientY;
                const deltaY = startY - endY;
                const deltaTime = Date.now() - startTime;
                const velocity = Math.abs(deltaY) / deltaTime;
                
                // 恢复平滑过渡
                const track = document.getElementById('track');
                track.style.transition = `transform ${transitionDuration}s cubic-bezier(0.25, 0.1, 0.25, 1)`;
                
                // 判断滑动距离或速度
                if (Math.abs(deltaY) > 80 || velocity > 0.6) {
                    if (deltaY > 0) {
                        // 向上滑 - 下一句
                        next();
                    } else {
                        // 向下滑 - 上一句
                        prev();
                    }
                } else {
                    // 回弹到当前句
                    goTo(current);
                }
            }, { passive: true });
        }

        setupGestures();

        function next() {
            if (current < lines.length - 1) {
                goTo(current + 1);
            }
        }

        function prev() {
            if (current > 0) {
                goTo(current - 1);
            }
        }

        // 语音识别
        function initVoice() {
            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            if (!SpeechRecognition) return;

            const recognition = new SpeechRecognition();
            recognition.continuous = false;
            recognition.interimResults = true;
            recognition.lang = 'zh-CN';

            recognition.onresult = (e) => {
                let text = '';
                for (let i = e.resultIndex; i < e.results.length; i++) {
                    text += e.results[i][0].transcript;
                }
                checkSpeech(text);
            };

            recognition.onend = () => {
                recognition.start();
            };

            recognition.start();
        }

        function checkSpeech(text) {
            text = text.toLowerCase().replace(/\s/g, '');
            const currentText = lines[current].toLowerCase().replace(/\s/g, '');
            
            // 读到当前行末尾，预判翻页
            if (currentText.length > 3 && text.includes(currentText.slice(-3))) {
                if (current < lines.length - 1) {
                    setTimeout(() => next(), 200);
                }
            }
            
            // 直接匹配下一句开头
            if (current < lines.length - 1) {
                const nextText = lines[current + 1].toLowerCase().replace(/\s/g, '');
                if (nextText.length > 2 && text.includes(nextText.slice(0, 2))) {
                    next();
                }
            }
        }

        // 设置面板控制
        function openSettings() {
            document.getElementById('overlay').classList.add('show');
            document.getElementById('settings').classList.add('open');
            document.getElementById('fab').classList.remove('show');
        }

        function closeSettings() {
            document.getElementById('overlay').classList.remove('show');
            document.getElementById('settings').classList.remove('open');
            document.getElementById('fab').classList.add('show');
        }

        function saveSettings() {
            closeSettings();
            // 重新计算位置确保准确
            setTimeout(() => goTo(current, false), 300);
        }

        // 设置调节
        function updateFont(val) {
            document.documentElement.style.setProperty('--font-size', val + 'px');
            document.getElementById('fontVal').textContent = val + 'px';
        }

        function updateLine(val) {
            const lh = val / 10;
            document.documentElement.style.setProperty('--line-height', lh);
            document.getElementById('lineVal').textContent = lh.toFixed(1);
        }

        function updateSmooth(val) {
            // 值越大，滚动越慢越平滑
            transitionDuration = val / 10;
            const texts = {3: '极快', 5: '快', 8: '标准', 10: '极平滑'};
            document.getElementById('smoothVal').textContent = texts[val] || '标准';
        }

        function exit() {
            if (confirm('退出演讲？')) {
                if (document.exitFullscreen) document.exitFullscreen();
                location.reload();
            }
        }

        // 防止休眠
        setInterval(() => {
            if (document.getElementById('prompter').classList.contains('active')) {
                window.location.href = window.location.href + '#';
                history.back();
            }
        }, 30000);

        // 键盘控制
        document.addEventListener('keydown', (e) => {
            if (!document.getElementById('prompter').classList.contains('active')) return;
            if (e.key === 'ArrowDown' || e.key === ' ') next();
            if (e.key === 'ArrowUp') prev();
            if (e.key === 'Escape') closeSettings();
        });
    </script>
</body>
</html>
