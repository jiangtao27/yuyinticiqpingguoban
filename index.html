<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>å¹³æ»‘æè¯å™¨</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        :root {
            --font-size: 36px;
            --line-height: 1.6;
        }

        html, body {
            width: 100%;
            height: 100%;
            background: #000;
            color: #fff;
            font-family: -apple-system, BlinkMacSystemFont, "SF Pro Display", sans-serif;
            overflow: hidden;
            position: fixed;
        }

        /* å¯åŠ¨é¡µ */
        .start {
            position: fixed;
            inset: 0;
            background: #000;
            padding: 40px 30px;
            z-index: 1000;
            display: flex;
            flex-direction: column;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
        }

        .start.hidden { display: none; }

        h1 {
            font-size: 28px;
            font-weight: 600;
            margin-bottom: 8px;
            color: #fff;
            margin-top: env(safe-area-inset-top);
        }

        .sub {
            color: #666;
            font-size: 15px;
            margin-bottom: 30px;
        }

        textarea {
            width: 100%;
            flex: 1;
            background: #111;
            border: 1px solid #333;
            border-radius: 12px;
            padding: 20px;
            color: #fff;
            font-size: 16px;
            line-height: 1.5;
            resize: none;
            margin-bottom: 15px;
            -webkit-user-select: text;
            font-family: inherit;
        }

        .btn {
            width: 100%;
            padding: 16px;
            background: #fff;
            color: #000;
            border: none;
            border-radius: 12px;
            font-size: 17px;
            font-weight: 600;
            cursor: pointer;
            margin-bottom: 10px;
            font-family: inherit;
        }

        .btn.secondary {
            background: #333;
            color: #fff;
        }

        /* æè¯å™¨ä¸»ä½“ */
        .prompter {
            display: none;
            position: fixed;
            inset: 0;
            background: #000;
            overflow: hidden;
            touch-action: pan-y;
        }

        .prompter.active {
            display: block;
        }

        /* æ»šåŠ¨è½¨é“ */
        .track {
            position: absolute;
            width: 100%;
            padding: 0 40px;
            top: 0;
            left: 0;
            transition: transform 0.8s cubic-bezier(0.25, 0.1, 0.25, 1);
            will-change: transform;
        }

        .line {
            width: 100%;
            text-align: center;
            font-size: var(--font-size);
            line-height: var(--line-height);
            color: #fff;
            padding: 15px 0;
            margin: 0;
            font-weight: 400;
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: auto;
            overflow: visible;
            word-wrap: break-word;
            word-break: break-all;
        }

        .line.active {
            transform: scale(1.05);
            font-weight: 600;
            text-shadow: 0 0 10px rgba(255,255,255,0.3);
            color: #fff;
        }

        /* ğŸ¤ éº¦å…‹é£æ”¶éŸ³æç¤º - å±å¹•è§’è½ */
        .mic-indicator {
            position: absolute;
            top: max(20px, env(safe-area-inset-top));
            left: 20px;
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 12px;
            background: rgba(30, 30, 30, 0.6);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            opacity: 0;
            transition: opacity 0.3s;
            z-index: 50;
            pointer-events: none;
        }

        .mic-indicator.active {
            opacity: 1;
        }

        .mic-icon {
            width: 8px;
            height: 8px;
            background: #30D158;
            border-radius: 50%;
            position: relative;
        }

        .mic-indicator.active .mic-icon {
            animation: mic-pulse 1.5s infinite;
        }

        @keyframes mic-pulse {
            0%, 100% { 
                transform: scale(1); 
                box-shadow: 0 0 0 0 rgba(48, 209, 88, 0.4);
            }
            50% { 
                transform: scale(1.2); 
                box-shadow: 0 0 0 8px rgba(48, 209, 88, 0);
            }
        }

        /* éŸ³é¢‘æ³¢å½¢æ¡ */
        .wave-bars {
            display: flex;
            align-items: center;
            gap: 3px;
            height: 16px;
        }

        .wave-bar {
            width: 3px;
            background: #30D158;
            border-radius: 2px;
            transition: height 0.1s;
        }

        .mic-text {
            font-size: 12px;
            color: #30D158;
            font-weight: 500;
        }

        /* è®¾ç½®æŒ‰é’® */
        .fab {
            position: absolute;
            bottom: 30px;
            right: 30px;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: rgba(255,255,255,0.1);
            backdrop-filter: blur(10px);
            border: none;
            color: rgba(255,255,255,0.5);
            font-size: 20px;
            z-index: 100;
            opacity: 0;
            transition: opacity 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
        }

        .fab.show {
            opacity: 1;
        }

        /* è®¾ç½®é¢æ¿ */
        .settings {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: rgba(20,20,20,0.98);
            border-radius: 20px 20px 0 0;
            padding: 25px;
            padding-bottom: calc(25px + env(safe-area-inset-bottom));
            transform: translateY(100%);
            transition: transform 0.3s;
            z-index: 200;
            max-height: 85vh;
            overflow-y: auto;
        }

        .settings.open {
            transform: translateY(0);
        }

        .setting-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            padding-bottom: 15px;
            border-bottom: 1px solid #333;
        }

        .setting-title {
            font-size: 20px;
            font-weight: 600;
            color: #fff;
        }

        .btn-close-x {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: #333;
            border: none;
            color: #fff;
            font-size: 18px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .setting-row {
            margin-bottom: 30px;
        }

        .label {
            display: flex;
            justify-content: space-between;
            font-size: 15px;
            color: #888;
            margin-bottom: 12px;
        }

        .value {
            color: #fff;
            font-weight: 600;
        }

        .slider {
            width: 100%;
            -webkit-appearance: none;
            height: 6px;
            border-radius: 3px;
            background: rgba(255,255,255,0.2);
            outline: none;
        }

        .slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            background: #fff;
            cursor: pointer;
            box-shadow: 0 2px 8px rgba(0,0,0,0.3);
        }

        .setting-buttons {
            display: flex;
            gap: 12px;
            margin-top: 30px;
        }

        .btn-half {
            flex: 1;
            padding: 16px;
            border: none;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
        }

        .btn-cancel {
            background: #333;
            color: #fff;
        }

        .btn-save {
            background: #fff;
            color: #000;
        }

        .overlay {
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.5);
            opacity: 0;
            pointer-events: none;
            z-index: 150;
        }

        .overlay.show {
            opacity: 1;
            pointer-events: auto;
        }

        /* æç¤º */
        .hint {
            position: absolute;
            top: 80px;
            left: 50%;
            transform: translateX(-50%);
            color: rgba(255,255,255,0.3);
            font-size: 14px;
            opacity: 0;
            transition: opacity 0.3s;
            pointer-events: none;
            text-align: center;
        }

        .hint.show {
            opacity: 1;
        }
    </style>
</head>
<body>

    <!-- å¯åŠ¨é¡µ -->
    <div class="start" id="start">
        <h1>å¹³æ»‘æè¯å™¨</h1>
        <div class="sub">åŒ€é€Ÿæ»šåŠ¨ Â· å¹³æ»‘ç¿»é¡µ Â· éº¦å…‹é£å¯è§†åŒ–</div>
        <textarea id="input" placeholder="ç²˜è´´å°è¯ï¼Œæ¯è¡Œä¸€å¥...">æ¬¢è¿ä½¿ç”¨å¹³æ»‘æè¯å™¨
ç°åœ¨ä¼šæœ‰éº¦å…‹é£æ”¶éŸ³æç¤º
å·¦ä¸Šè§’æ˜¾ç¤ºç»¿è‰²æŒ‡ç¤ºç¯
å½“éº¦å…‹é£æ­£åœ¨æ”¶éŸ³æ—¶
ä¼šçœ‹åˆ°ç»¿è‰²è„‰å†²å’Œæ³¢å½¢
è¿™æ ·ä½ å°±çŸ¥é“å®ƒåœ¨å·¥ä½œ
ä¸Šä¸‹æ»‘åŠ¨å±å¹•ç¿»é¡µ
ç¥ä½ æ¼”è®²æˆåŠŸ</textarea>
        <button class="btn" onclick="start()">å¼€å§‹æ¼”è®²</button>
        <button class="btn secondary" onclick="startFullscreen()">å…¨å±æ¨¡å¼</button>
    </div>

    <!-- æè¯å™¨ -->
    <div class="prompter" id="prompter">
        <div class="track" id="track"></div>
        
        <!-- ğŸ¤ éº¦å…‹é£æ”¶éŸ³æç¤º -->
        <div class="mic-indicator" id="micIndicator">
            <div class="mic-icon"></div>
            <div class="wave-bars" id="waveBars">
                <div class="wave-bar" style="height: 4px;"></div>
                <div class="wave-bar" style="height: 8px;"></div>
                <div class="wave-bar" style="height: 6px;"></div>
                <div class="wave-bar" style="height: 10px;"></div>
                <div class="wave-bar" style="height: 5px;"></div>
            </div>
            <span class="mic-text">è†å¬ä¸­</span>
        </div>
        
        <div class="hint" id="hint">ä¸Šæ»‘ä¸‹ä¸€å¥ Â· ä¸‹æ»‘ä¸Šä¸€å¥</div>
        
        <button class="fab" id="fab" onclick="openSettings()">âš™ï¸</button>
        
        <div class="overlay" id="overlay" onclick="closeSettings()"></div>
        
        <div class="settings" id="settings">
            <div class="setting-header">
                <div class="setting-title">è®¾ç½®</div>
                <button class="btn-close-x" onclick="closeSettings()">âœ•</button>
            </div>

            <div class="setting-row">
                <div class="label">
                    <span>å­—ä½“å¤§å°</span>
                    <span class="value" id="fontVal">36px</span>
                </div>
                <input type="range" class="slider" min="20" max="72" value="36" id="fontSlider" oninput="updateFont(this.value)">
            </div>

            <div class="setting-row">
                <div class="label">
                    <span>è¡Œé—´è·</span>
                    <span class="value" id="lineVal">1.6</span>
                </div>
                <input type="range" class="slider" min="10" max="30" value="16" id="lineSlider" oninput="updateLine(this.value)">
            </div>

            <div class="setting-row">
                <div class="label">
                    <span>æ»šåŠ¨å¹³æ»‘åº¦</span>
                    <span class="value" id="smoothVal">æ ‡å‡†</span>
                </div>
                <input type="range" class="slider" min="3" max="10" value="8" id="smoothSlider" oninput="updateSmooth(this.value)">
            </div>

            <div class="setting-buttons">
                <button class="btn-half btn-cancel" onclick="closeSettings()">å–æ¶ˆ</button>
                <button class="btn-half btn-save" onclick="saveSettings()">å®Œæˆ</button>
            </div>
        </div>
    </div>

    <script>
        let lines = [];
        let lineEls = [];
        let current = 0;
        let targetY = 0;
        let transitionDuration = 0.8;
        let isTouching = false;
        let startY = 0;
        let startTime = 0;
        let recognition = null;
        let isRecording = false;

        // å¼€å§‹
        function start() {
            const text = document.getElementById('input').value.trim();
            if (!text) return alert('è¯·è¾“å…¥å°è¯');
            
            lines = text.split('\n').filter(l => l.trim());
            document.getElementById('start').classList.add('hidden');
            document.getElementById('prompter').classList.add('active');
            
            init();
            
            setTimeout(() => {
                document.getElementById('fab').classList.add('show');
                document.getElementById('hint').classList.add('show');
                setTimeout(() => document.getElementById('hint').classList.remove('show'), 3000);
                initVoice(); // å¯åŠ¨éº¦å…‹é£
            }, 100);
        }

        function startFullscreen() {
            start();
            setTimeout(() => {
                const el = document.documentElement;
                if (el.requestFullscreen) el.requestFullscreen();
                else if (el.webkitRequestFullscreen) el.webkitRequestFullscreen();
            }, 100);
        }

        function init() {
            const track = document.getElementById('track');
            track.innerHTML = '';
            lineEls = [];
            
            lines.forEach((line) => {
                const div = document.createElement('div');
                div.className = 'line';
                div.textContent = line;
                track.appendChild(div);
                lineEls.push(div);
            });

            setTimeout(() => {
                goTo(0, false);
            }, 50);
        }

        // å¹³æ»‘æ»šåŠ¨
        function goTo(index, animate = true) {
            if (index < 0 || index >= lines.length) return;
            
            current = index;
            
            const viewportHeight = window.innerHeight;
            const focusLine = lineEls[index];
            const lineHeight = focusLine.offsetHeight;
            const lineTop = focusLine.offsetTop;
            
            targetY = -(lineTop - viewportHeight * 0.4 + lineHeight/2);
            
            const track = document.getElementById('track');
            if (!animate) {
                track.style.transition = 'none';
                track.style.transform = `translateY(${targetY}px)`;
            } else {
                track.style.transition = `transform ${transitionDuration}s cubic-bezier(0.25, 0.1, 0.25, 1)`;
                track.style.transform = `translateY(${targetY}px)`;
            }
            
            lineEls.forEach((el, i) => {
                el.classList.toggle('active', i === index);
            });
        }

        // æ‰‹åŠ¿æ§åˆ¶
        function setupGestures() {
            const stage = document.getElementById('prompter');
            
            stage.addEventListener('touchstart', (e) => {
                startY = e.touches[0].clientY;
                startTime = Date.now();
                isTouching = true;
                document.getElementById('track').style.transition = 'none';
            }, { passive: true });

            stage.addEventListener('touchmove', (e) => {
                if (!isTouching) return;
                const currentY_touch = e.touches[0].clientY;
                const deltaY = startY - currentY_touch;
                const tempY = targetY - deltaY * 0.5;
                document.getElementById('track').style.transform = `translateY(${tempY}px)`;
            }, { passive: true });

            stage.addEventListener('touchend', (e) => {
                if (!isTouching) return;
                isTouching = false;
                
                const endY = e.changedTouches[0].clientY;
                const deltaY = startY - endY;
                const deltaTime = Date.now() - startTime;
                const velocity = Math.abs(deltaY) / deltaTime;
                
                document.getElementById('track').style.transition = `transform ${transitionDuration}s cubic-bezier(0.25, 0.1, 0.25, 1)`;
                
                if (Math.abs(deltaY) > 80 || velocity > 0.6) {
                    if (deltaY > 0) next();
                    else prev();
                } else {
                    goTo(current);
                }
            }, { passive: true });
        }

        setupGestures();

        function next() {
            if (current < lines.length - 1) goTo(current + 1);
        }

        function prev() {
            if (current > 0) goTo(current - 1);
        }

        // ğŸ¤ éº¦å…‹é£è¯­éŸ³è¯†åˆ« + å¯è§†åŒ–
        function initVoice() {
            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            if (!SpeechRecognition) {
                console.log('æµè§ˆå™¨ä¸æ”¯æŒè¯­éŸ³è¯†åˆ«');
                return;
            }

            recognition = new SpeechRecognition();
            recognition.continuous = false; // iOSå¿…é¡»false
            recognition.interimResults = true;
            recognition.lang = 'zh-CN';

            recognition.onstart = () => {
                isRecording = true;
                document.getElementById('micIndicator').classList.add('active');
                animateWave(); // å¯åŠ¨æ³¢å½¢åŠ¨ç”»
                console.log('ğŸ¤ å¼€å§‹è†å¬');
            };

            recognition.onresult = (e) => {
                let text = '';
                for (let i = e.resultIndex; i < e.results.length; i++) {
                    text += e.results[i][0].transcript;
                }
                checkSpeech(text);
            };

            recognition.onerror = (e) => {
                if (e.error === 'not-allowed') {
                    console.log('éº¦å…‹é£æƒé™è¢«æ‹’ç»');
                    stopVoice();
                }
            };

            recognition.onend = () => {
                if (isRecording) {
                    // iOSè‡ªåŠ¨é‡å¯
                    setTimeout(() => {
                        if (isRecording) recognition.start();
                    }, 100);
                } else {
                    document.getElementById('micIndicator').classList.remove('active');
                }
            };

            recognition.start();
        }

        function stopVoice() {
            isRecording = false;
            if (recognition) recognition.stop();
            document.getElementById('micIndicator').classList.remove('active');
        }

        // éŸ³é¢‘æ³¢å½¢åŠ¨ç”»
        function animateWave() {
            if (!isRecording) return;
            
            const bars = document.querySelectorAll('.wave-bar');
            bars.forEach(bar => {
                const height = Math.random() * 12 + 4; // 4-16pxéšæœºé«˜åº¦
                bar.style.height = height + 'px';
            });
            
            requestAnimationFrame(() => {
                setTimeout(animateWave, 100); // 100msæ›´æ–°ä¸€æ¬¡
            });
        }

        // è¯­éŸ³è¯†åˆ«ç¿»é¡µé€»è¾‘
        function checkSpeech(text) {
            text = text.toLowerCase().replace(/\s/g, '');
            const currentText = lines[current].toLowerCase().replace(/\s/g, '');
            
            // è¯»åˆ°å½“å‰è¡Œæœ«å°¾ï¼Œé¢„åˆ¤ç¿»é¡µ
            if (currentText.length > 3 && text.includes(currentText.slice(-3))) {
                if (current < lines.length - 1) {
                    setTimeout(() => next(), 200);
                }
            }
            
            // ç›´æ¥åŒ¹é…ä¸‹ä¸€å¥å¼€å¤´
            if (current < lines.length - 1) {
                const nextText = lines[current + 1].toLowerCase().replace(/\s/g, '');
                if (nextText.length > 2 && text.includes(nextText.slice(0, 2))) {
                    next();
                }
            }
        }

        // è®¾ç½®é¢æ¿
        function openSettings() {
            document.getElementById('overlay').classList.add('show');
            document.getElementById('settings').classList.add('open');
            document.getElementById('fab').classList.remove('show');
            // æš‚åœè¯­éŸ³æ˜¾ç¤ºï¼Œé¿å…å¹²æ‰°è®¾ç½®
            document.getElementById('micIndicator').style.opacity = '0';
        }

        function closeSettings() {
            document.getElementById('overlay').classList.remove('show');
            document.getElementById('settings').classList.remove('open');
            document.getElementById('fab').classList.add('show');
            document.getElementById('micIndicator').style.opacity = '';
            setTimeout(() => goTo(current, false), 300);
        }

        function saveSettings() {
            closeSettings();
        }

        function updateFont(val) {
            document.documentElement.style.setProperty('--font-size', val + 'px');
            document.getElementById('fontVal').textContent = val + 'px';
        }

        function updateLine(val) {
            const lh = val / 10;
            document.documentElement.style.setProperty('--line-height', lh);
            document.getElementById('lineVal').textContent = lh.toFixed(1);
        }

        function updateSmooth(val) {
            transitionDuration = val / 10;
            const texts = {3: 'æå¿«', 5: 'å¿«', 8: 'æ ‡å‡†', 10: 'æå¹³æ»‘'};
            document.getElementById('smoothVal').textContent = texts[val] || 'æ ‡å‡†';
        }

        function exit() {
            if (confirm('é€€å‡ºæ¼”è®²ï¼Ÿ')) {
                stopVoice();
                if (document.exitFullscreen) document.exitFullscreen();
                location.reload();
            }
        }

        // é˜²æ­¢ä¼‘çœ 
        setInterval(() => {
            if (document.getElementById('prompter').classList.contains('active')) {
                window.location.href = window.location.href + '#';
                history.back();
            }
        }, 30000);

        // é”®ç›˜
        document.addEventListener('keydown', (e) => {
            if (!document.getElementById('prompter').classList.contains('active')) return;
            if (e.key === 'ArrowDown' || e.key === ' ') next();
            if (e.key === 'ArrowUp') prev();
            if (e.key === 'Escape') closeSettings();
        });
    </script>
</body>
</html>
