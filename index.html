<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>纯净提词器</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        :root {
            --font-size: 36px;
            --line-height: 1.6;
        }

        html, body {
            width: 100%;
            height: 100%;
            background: #000;
            color: #fff;
            font-family: -apple-system, BlinkMacSystemFont, "SF Pro Display", sans-serif;
            overflow: hidden;
            position: fixed;
        }

        /* 启动页 */
        .start {
            position: fixed;
            inset: 0;
            background: #000;
            padding: 40px 30px;
            z-index: 1000;
            display: flex;
            flex-direction: column;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
        }

        .start.hidden { display: none; }

        h1 {
            font-size: 28px;
            font-weight: 600;
            margin-bottom: 8px;
            color: #fff;
            margin-top: env(safe-area-inset-top);
        }

        .sub {
            color: #666;
            font-size: 15px;
            margin-bottom: 30px;
        }

        textarea {
            width: 100%;
            flex: 1;
            background: #111;
            border: 1px solid #333;
            border-radius: 12px;
            padding: 20px;
            color: #fff;
            font-size: 16px;
            line-height: 1.5;
            resize: none;
            margin-bottom: 15px;
            -webkit-user-select: text;
            font-family: inherit;
        }

        .btn {
            width: 100%;
            padding: 16px;
            background: #fff;
            color: #000;
            border: none;
            border-radius: 12px;
            font-size: 17px;
            font-weight: 600;
            cursor: pointer;
            margin-bottom: 10px;
            font-family: inherit;
        }

        .btn.secondary {
            background: #333;
            color: #fff;
        }

        /* 提词器主体 */
        .prompter {
            display: none;
            position: fixed;
            inset: 0;
            background: #000;
            overflow: hidden;
            touch-action: pan-y;
        }

        .prompter.active {
            display: block;
        }

        /* 滚动轨道 - 修复文字显示不全 */
        .track {
            position: absolute;
            width: 100%;
            padding: 0 40px;
            top: 0;
            left: 0;
            will-change: transform;
        }

        /* 字幕行 - 修复显示不全问题 */
        .line {
            width: 100%;
            text-align: center;
            font-size: var(--font-size);
            line-height: var(--line-height);
            color: #fff;
            padding: 15px 0; /* 增加上下padding确保不截断 */
            margin: 0;
            font-weight: 400;
            display: flex;
            align-items: center;
            justify-content: center;
            /* 移除固定min-height，使用自然高度+padding */
            min-height: auto;
            overflow: visible; /* 确保文字不被截断 */
            word-wrap: break-word;
            word-break: break-all;
        }

        .line.active {
            transform: scale(1.05);
            font-weight: 600;
            text-shadow: 0 0 10px rgba(255,255,255,0.3);
            color: #fff;
        }

        /* 浮动设置按钮 */
        .fab {
            position: absolute;
            bottom: 30px;
            right: 30px;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: rgba(255,255,255,0.1);
            backdrop-filter: blur(10px);
            border: none;
            color: rgba(255,255,255,0.5);
            font-size: 20px;
            z-index: 100;
            opacity: 0;
            transition: opacity 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            -webkit-user-select: none;
        }

        .fab.show {
            opacity: 1;
        }

        /* 设置面板 */
        .settings {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: rgba(10,10,10,0.98);
            border-radius: 20px 20px 0 0;
            padding: 30px;
            padding-bottom: calc(30px + env(safe-area-inset-bottom));
            transform: translateY(100%);
            transition: transform 0.3s;
            z-index: 200;
            max-height: 80vh;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
        }

        .settings.open {
            transform: translateY(0);
        }

        .setting-row {
            margin-bottom: 25px;
        }

        .label {
            display: flex;
            justify-content: space-between;
            font-size: 14px;
            color: #666;
            margin-bottom: 10px;
            font-family: inherit;
        }

        .value {
            color: #fff;
        }

        .slider {
            width: 100%;
            -webkit-appearance: none;
            height: 4px;
            border-radius: 2px;
            background: rgba(255,255,255,0.2);
            outline: none;
        }

        .slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: #fff;
            cursor: pointer;
        }

        .btn-close {
            width: 100%;
            padding: 16px;
            background: #333;
            border: none;
            border-radius: 12px;
            color: #fff;
            font-size: 16px;
            margin-top: 10px;
            font-family: inherit;
            cursor: pointer;
        }

        .overlay {
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.7);
            opacity: 0;
            pointer-events: none;
            z-index: 150;
        }

        .overlay.show {
            opacity: 1;
            pointer-events: auto;
        }

        /* 速度提示 */
        .hint {
            position: absolute;
            top: 100px;
            left: 50%;
            transform: translateX(-50%);
            color: rgba(255,255,255,0.3);
            font-size: 14px;
            opacity: 0;
            transition: opacity 0.3s;
            pointer-events: none;
            text-align: center;
            white-space: nowrap;
        }

        .hint.show {
            opacity: 1;
        }

        /* 全屏强制隐藏浏览器UI */
        :fullscreen {
            width: 100vw;
            height: 100vh;
        }
        
        :fullscreen .prompter {
            width: 100vw;
            height: 100vh;
        }
    </style>
</head>
<body>

    <!-- 启动页 -->
    <div class="start" id="start">
        <h1>纯净提词器</h1>
        <div class="sub">全屏无抬头 · 纯白字幕 · 手势滑动 · 支持缩放</div>
        <textarea id="input" placeholder="粘贴台词，每行一句...">欢迎使用纯净提词器
现在可以双指缩放调整大小
上下滑动屏幕翻页
不用点击任何地方
当前句子在屏幕中央偏上
所有文字都是纯白色
横屏时请旋转手机后点击全屏
确保没有任何抬头遮挡
文字显示完整不截断
祝你演讲成功</textarea>
        <button class="btn" onclick="start()">开始演讲</button>
        <button class="btn secondary" onclick="startFullscreen()">全屏模式</button>
    </div>

    <!-- 提词器 -->
    <div class="prompter" id="prompter">
        <div class="track" id="track"></div>
        
        <div class="hint" id="hint">上滑下一句 · 下滑上一句<br>双指缩放调整大小</div>
        
        <button class="fab" id="fab" onclick="openSettings()">⚙️</button>
        
        <div class="overlay" id="overlay" onclick="closeSettings()"></div>
        <div class="settings" id="settings">
            <div class="setting-row">
                <div class="label">
                    <span>字体大小</span>
                    <span class="value" id="fontVal">36px</span>
                </div>
                <input type="range" class="slider" min="20" max="72" value="36" oninput="setFont(this.value)">
            </div>
            <div class="setting-row">
                <div class="label">
                    <span>行间距</span>
                    <span class="value" id="lineVal">1.6</span>
                </div>
                <input type="range" class="slider" min="10" max="30" value="16" oninput="setLine(this.value)">
            </div>
            <div class="setting-row">
                <div class="label">
                    <span>滚动速度</span>
                    <span class="value" id="speedVal">1.0x</span>
                </div>
                <input type="range" class="slider" min="5" max="25" value="10" oninput="setSpeed(this.value)">
            </div>
            <button class="btn-close" onclick="exit()">退出演讲</button>
        </div>
    </div>

    <script>
        let lines = [];
        let lineEls = [];
        let current = 0;
        let offset = 0;
        let target = 0;
        let scrollSpeed = 1.0;
        let autoScroll = null;
        let heights = [];
        let cumulative = [];
        let recognition = null;
        let isTouching = false;

        function start() {
            const text = document.getElementById('input').value.trim();
            if (!text) return alert('请输入台词');
            
            lines = text.split('\n').filter(l => l.trim());
            document.getElementById('start').classList.add('hidden');
            document.getElementById('prompter').classList.add('active');
            
            init();
            
            setTimeout(() => {
                document.getElementById('fab').classList.add('show');
                document.getElementById('hint').classList.add('show');
                setTimeout(() => document.getElementById('hint').classList.remove('show'), 4000);
                startScroll();
                initVoice();
            }, 100);
        }

        function startFullscreen() {
            start();
            setTimeout(() => {
                const el = document.documentElement;
                if (el.requestFullscreen) el.requestFullscreen();
                else if (el.webkitRequestFullscreen) el.webkitRequestFullscreen();
                else if (el.msRequestFullscreen) el.msRequestFullscreen();
            }, 100);
        }

        function init() {
            const track = document.getElementById('track');
            track.innerHTML = '';
            lineEls = [];
            
            lines.forEach((line) => {
                const div = document.createElement('div');
                div.className = 'line';
                div.textContent = line;
                track.appendChild(div);
                lineEls.push(div);
            });

            // 计算布局 - 使用实际高度确保不截断
            setTimeout(() => {
                let sum = 0;
                heights = [];
                cumulative = [];
                lineEls.forEach(el => {
                    // 获取实际渲染高度，包括padding
                    const rect = el.getBoundingClientRect();
                    const h = rect.height;
                    heights.push(h);
                    cumulative.push(sum);
                    sum += h;
                });
                
                goTo(0, false);
            }, 50);
        }

        function goTo(index, smooth = true) {
            if (index < 0 || index >= lines.length) return;
            
            const viewport = window.innerHeight;
            const focus = viewport * 0.4; // 中央偏上
            
            target = focus - (cumulative[index] + heights[index]/2);
            
            if (!smooth) {
                offset = target;
                updateTrack();
            }
            
            lineEls.forEach((el, i) => {
                el.classList.toggle('active', i === index);
            });
            
            current = index;
        }

        function updateTrack() {
            document.getElementById('track').style.transform = `translateY(${offset}px)`;
        }

        function startScroll() {
            function animate() {
                const diff = target - offset;
                if (Math.abs(diff) > 0.5) {
                    const step = Math.min(Math.abs(diff) * 0.08 * scrollSpeed, 5 * scrollSpeed);
                    offset += diff > 0 ? step : -step;
                    updateTrack();
                }
                autoScroll = requestAnimationFrame(animate);
            }
            animate();
        }

        // 手势控制
        let touchStartY = 0;
        let touchStartTime = 0;

        function setupGestures() {
            const stage = document.getElementById('prompter');
            
            stage.addEventListener('touchstart', (e) => {
                touchStartY = e.touches[0].clientY;
                touchStartTime = Date.now();
                isTouching = true;
            }, { passive: true });

            stage.addEventListener('touchmove', (e) => {
                if (!isTouching) return;
                
                const currentY = e.touches[0].clientY;
                const diff = touchStartY - currentY;
                
                // 跟随手指
                const viewport = window.innerHeight;
                const focus = viewport * 0.4;
                const tempTarget = focus - (cumulative[current] + heights[current]/2) - diff;
                offset = tempTarget;
                updateTrack();
            }, { passive: true });

            stage.addEventListener('touchend', (e) => {
                if (!isTouching) return;
                isTouching = false;
                
                const endY = e.changedTouches[0].clientY;
                const diff = touchStartY - endY;
                const duration = Date.now() - touchStartTime;
                const velocity = Math.abs(diff) / duration;
                
                if (Math.abs(diff) > 50 || velocity > 0.5) {
                    if (diff > 0) {
                        next();
                    } else {
                        prev();
                    }
                } else {
                    goTo(current);
                }
            }, { passive: true });
        }

        setupGestures();

        function next() {
            if (current < lines.length - 1) goTo(current + 1);
        }

        function prev() {
            if (current > 0) goTo(current - 1);
        }

        // 语音识别
        function initVoice() {
            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            if (!SpeechRecognition) return;

            recognition = new SpeechRecognition();
            recognition.continuous = false;
            recognition.interimResults = true;
            recognition.lang = 'zh-CN';

            recognition.onstart = () => {};

            recognition.onresult = (e) => {
                let text = '';
                for (let i = e.resultIndex; i < e.results.length; i++) {
                    text += e.results[i][0].transcript;
                }
                checkSpeech(text);
            };

            recognition.onend = () => {
                if (recognition) setTimeout(() => recognition.start(), 50);
            };

            recognition.start();
        }

        function checkSpeech(text) {
            text = text.toLowerCase().replace(/\s/g, '');
            const currentText = lines[current].toLowerCase().replace(/\s/g, '');
            
            if (currentText.length > 3 && text.includes(currentText.slice(-3))) {
                if (current < lines.length - 1) {
                    setTimeout(() => next(), 150);
                }
            }
            
            if (current < lines.length - 1) {
                const nextText = lines[current + 1].toLowerCase().replace(/\s/g, '');
                if (nextText.length > 2 && text.includes(nextText.slice(0, 2))) {
                    next();
                }
            }
        }

        // 设置
        function setFont(val) {
            document.documentElement.style.setProperty('--font-size', val + 'px');
            document.getElementById('fontVal').textContent = val + 'px';
            // 重新计算高度确保不截断
            setTimeout(() => {
                let sum = 0;
                cumulative = [];
                lineEls.forEach((el, i) => {
                    const rect = el.getBoundingClientRect();
                    const h = rect.height;
                    heights[i] = h;
                    cumulative.push(sum);
                    sum += h;
                });
                goTo(current, false);
            }, 100);
        }

        function setLine(val) {
            const lh = val / 10;
            document.documentElement.style.setProperty('--line-height', lh);
            document.getElementById('lineVal').textContent = lh.toFixed(1);
            setTimeout(() => {
                let sum = 0;
                cumulative = [];
                lineEls.forEach((el, i) => {
                    const rect = el.getBoundingClientRect();
                    const h = rect.height;
                    heights[i] = h;
                    cumulative.push(sum);
                    sum += h;
                });
                goTo(current, false);
            }, 100);
        }

        function setSpeed(val) {
            scrollSpeed = val / 10;
            document.getElementById('speedVal').textContent = scrollSpeed.toFixed(1) + 'x';
        }

        function openSettings() {
            document.getElementById('overlay').classList.add('show');
            document.getElementById('settings').classList.add('open');
            document.getElementById('fab').classList.remove('show');
        }

        function closeSettings() {
            document.getElementById('overlay').classList.remove('show');
            document.getElementById('settings').classList.remove('open');
            document.getElementById('fab').classList.add('show');
        }

        function exit() {
            if (confirm('退出演讲？')) {
                if (document.exitFullscreen) document.exitFullscreen();
                location.reload();
            }
        }

        // 防止休眠
        setInterval(() => {
            if (document.getElementById('prompter').classList.contains('active')) {
                window.location.href = window.location.href + '#';
                history.back();
            }
        }, 30000);
    </script>
</body>
</html>
