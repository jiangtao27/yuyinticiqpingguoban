<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>ä¸æ»‘æè¯å™¨ Pro</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
            -webkit-touch-callout: none;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "SF Pro Display", "Segoe UI", sans-serif;
            background: #000;
            color: #fff;
            height: 100vh;
            overflow: hidden;
            touch-action: manipulation;
        }

        /* å¯åŠ¨é¡µ */
        .start-screen {
            position: fixed;
            inset: 0;
            background: linear-gradient(180deg, #1c1c1e 0%, #000 100%);
            display: flex;
            flex-direction: column;
            padding: 40px 30px;
            z-index: 1000;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
        }

        .start-screen.hidden { display: none; }

        .ios-title {
            font-size: 34px;
            font-weight: 700;
            background: linear-gradient(135deg, #30D158 0%, #0A84FF 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin: 20px 0 10px;
            letter-spacing: -0.5px;
        }

        .ios-subtitle {
            color: #8E8E93;
            font-size: 16px;
            margin-bottom: 30px;
        }

        .input-area {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .ios-textarea {
            width: 100%;
            flex: 1;
            background: #2C2C2E;
            border: 1px solid #3A3A3C;
            border-radius: 16px;
            padding: 20px;
            color: #fff;
            font-size: 17px;
            line-height: 1.5;
            resize: none;
            -webkit-user-select: text;
            font-family: inherit;
        }

        .ios-btn {
            background: #30D158;
            color: #000;
            border: none;
            padding: 18px;
            border-radius: 14px;
            font-size: 17px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s;
        }

        .ios-btn:active { transform: scale(0.96); }
        .ios-btn.secondary { background: #2C2C2E; color: #0A84FF; }

        /* æè¯å™¨ä¸»ç•Œé¢ */
        .prompter {
            display: none;
            position: fixed;
            inset: 0;
            background: #000;
            flex-direction: column;
        }

        .prompter.active { display: flex; }

        /* é¡¶éƒ¨çŠ¶æ€æ  */
        .status-bar {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            padding: 15px 25px;
            padding-top: max(15px, env(safe-area-inset-top));
            background: linear-gradient(to bottom, rgba(0,0,0,0.9) 0%, transparent 100%);
            display: flex;
            justify-content: space-between;
            align-items: center;
            z-index: 100;
            pointer-events: none;
        }

        .status-pill {
            background: rgba(60,60,67,0.6);
            backdrop-filter: blur(10px);
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 13px;
            color: #fff;
            display: flex;
            align-items: center;
            gap: 8px;
            pointer-events: auto;
        }

        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #8E8E93;
            transition: all 0.3s;
        }

        .status-dot.active {
            background: #30D158;
            box-shadow: 0 0 0 4px rgba(48,209,88,0.3);
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        /* ä¸æ»‘æ»šåŠ¨å®¹å™¨ - å…³é”®éƒ¨åˆ† */
        .scroll-container {
            flex: 1;
            overflow-y: scroll;
            -webkit-overflow-scrolling: touch;
            scroll-behavior: smooth; /* åŸç”Ÿå¹³æ»‘æ»šåŠ¨ */
            scroll-snap-type: y mandatory; /* å¯é€‰ï¼šå¸é™„æ•ˆæœ */
            padding: 50vh 0; /* ä¸Šä¸‹ç•™ç™½ï¼Œè®©ç¬¬ä¸€è¡Œå’Œæœ€åä¸€è¡Œèƒ½å±…ä¸­ */
            position: relative;
        }

        .script-wrapper {
            width: 100%;
            max-width: 800px;
            margin: 0 auto;
            padding: 0 30px;
        }

        .script-line {
            font-size: 32px;
            line-height: 1.8;
            color: rgba(255,255,255,0.25);
            margin: 30px 0;
            text-align: center;
            transition: all 0.6s cubic-bezier(0.25, 0.46, 0.45, 0.94);
            transform-origin: center;
            scroll-snap-align: center; /* å¸é™„åˆ°ä¸­é—´ */
            min-height: 1.8em;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 10px 0;
            font-weight: 400;
            letter-spacing: 0.3px;
        }

        /* å½“å‰è¡Œé«˜äº®æ ·å¼ */
        .script-line.active {
            color: #fff;
            font-size: 38px;
            font-weight: 600;
            text-shadow: 0 0 30px rgba(255,255,255,0.15);
            transform: scale(1.05);
        }

        /* ä¸Šä¸€è¡Œæ¸éš */
        .script-line.prev {
            color: rgba(255,255,255,0.15);
            transform: scale(0.95);
        }

        /* iPad æ¨ªå±ä¼˜åŒ– */
        @media (min-width: 768px) and (orientation: landscape) {
            .script-line { font-size: 44px; }
            .script-line.active { font-size: 52px; }
        }

        /* åº•éƒ¨æ§åˆ¶æ  - æ‚¬æµ®çƒè®¾è®¡ */
        .controls {
            position: absolute;
            bottom: 30px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(30,30,30,0.8);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            padding: 8px;
            border-radius: 35px;
            display: flex;
            align-items: center;
            gap: 8px;
            border: 1px solid rgba(255,255,255,0.1);
            box-shadow: 0 10px 40px rgba(0,0,0,0.5);
            z-index: 100;
        }

        .ctrl-btn {
            width: 55px;
            height: 55px;
            border-radius: 50%;
            border: none;
            background: transparent;
            color: #fff;
            font-size: 22px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s;
            position: relative;
        }

        .ctrl-btn:active { transform: scale(0.9); }

        .ctrl-btn.main {
            background: #30D158;
            color: #000;
            width: 65px;
            height: 65px;
            font-size: 28px;
        }

        .ctrl-btn.main.recording {
            background: #FF3B30;
            animation: recording-pulse 2s infinite;
        }

        @keyframes recording-pulse {
            0%, 100% { box-shadow: 0 0 0 0 rgba(255,59,48,0.4); }
            50% { box-shadow: 0 0 0 15px rgba(255,59,48,0); }
        }

        .ctrl-btn.small {
            width: 44px;
            height: 44px;
            font-size: 18px;
            color: #8E8E93;
        }

        /* é€Ÿåº¦æŒ‡ç¤ºå™¨ */
        .speed-indicator {
            position: absolute;
            bottom: 110px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0,0,0,0.7);
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 13px;
            color: #8E8E93;
            opacity: 0;
            transition: opacity 0.3s;
            pointer-events: none;
            white-space: nowrap;
        }

        .speed-indicator.show { opacity: 1; }

        /* è®¾ç½®é¢æ¿ */
        .settings-sheet {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: rgba(44,44,46,0.98);
            backdrop-filter: blur(20px);
            border-radius: 24px 24px 0 0;
            padding: 25px;
            padding-bottom: max(25px, env(safe-area-inset-bottom));
            transform: translateY(100%);
            transition: transform 0.3s cubic-bezier(0.25, 0.46, 0.45, 0.94);
            z-index: 200;
        }

        .settings-sheet.open { transform: translateY(0); }

        .sheet-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
        }

        .sheet-title { font-size: 20px; font-weight: 600; }

        .close-btn {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: rgba(255,255,255,0.1);
            border: none;
            color: #fff;
            font-size: 18px;
        }

        .setting-row {
            margin-bottom: 25px;
        }

        .setting-label {
            font-size: 15px;
            color: #8E8E93;
            margin-bottom: 12px;
            display: block;
        }

        .ios-slider {
            width: 100%;
            -webkit-appearance: none;
            height: 6px;
            border-radius: 3px;
            background: rgba(255,255,255,0.2);
            outline: none;
        }

        .ios-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 28px;
            height: 28px;
            border-radius: 50%;
            background: #fff;
            box-shadow: 0 2px 10px rgba(0,0,0,0.3);
            cursor: pointer;
        }

        .speed-labels {
            display: flex;
            justify-content: space-between;
            font-size: 13px;
            color: #8E8E93;
            margin-top: 8px;
        }

        .overlay {
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.6);
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s;
            z-index: 150;
        }

        .overlay.show { opacity: 1; pointer-events: auto; }

        /* Toast */
        .toast {
            position: fixed;
            top: 100px;
            left: 50%;
            transform: translateX(-50%) translateY(-20px);
            background: rgba(60,60,67,0.95);
            color: #fff;
            padding: 12px 24px;
            border-radius: 25px;
            font-size: 15px;
            opacity: 0;
            transition: all 0.3s;
            z-index: 1000;
            pointer-events: none;
            backdrop-filter: blur(10px);
        }

        .toast.show {
            opacity: 1;
            transform: translateX(-50%) translateY(0);
        }

        /* æ»šåŠ¨æ¡éšè— */
        .scroll-container::-webkit-scrollbar { display: none; }
        .scroll-container { -ms-overflow-style: none; scrollbar-width: none; }

        /* è¿›åº¦æ¡ */
        .progress-bar {
            position: absolute;
            top: 0;
            left: 0;
            height: 3px;
            background: linear-gradient(90deg, #30D158, #0A84FF);
            transition: width 0.5s ease;
            z-index: 101;
        }
    </style>
</head>
<body>

    <!-- å¯åŠ¨é¡µ -->
    <div class="start-screen" id="startScreen">
        <div class="ios-title">ğŸ™ï¸ ä¸æ»‘æè¯å™¨</div>
        <div class="ios-subtitle">å¹³æ»‘æ»šåŠ¨ Â· æ™ºèƒ½è·Ÿéš Â· å‘Šåˆ«è·³è·ƒ</div>
        
        <div class="input-area">
            <textarea class="ios-textarea" id="scriptInput" placeholder="ç²˜è´´å°è¯ï¼Œæ¯è¡Œä¸€å¥...">æ¬¢è¿æ¥åˆ°ä¸æ»‘æè¯å™¨
è¿™æ˜¯ä¸€ä¸ªå¹³æ»‘æ»šåŠ¨çš„æ¼”ç¤º
ä½ ä¼šå‘ç°åˆ‡æ¢æ—¶ä¸å†è·³è·ƒ
è€Œæ˜¯åƒç”µå½±å­—å¹•ä¸€æ ·æµç•…
è¯»å¾—æ…¢ä¼šè‡ªåŠ¨ç­‰å¾…
è¯»å¾—å¿«ä¼šè¿…é€Ÿè·Ÿä¸Š
æ”¯æŒ iPhone å’Œ iPad
æ¨ªç«–å±éƒ½èƒ½å®Œç¾é€‚é…
ç¥ä½ æ¼”è®²æˆåŠŸ</textarea>
            
            <button class="ios-btn" onclick="start()">å¼€å§‹æ¼”è®²</button>
            <button class="ios-btn secondary" onclick="loadDemo()">åŠ è½½ç¤ºä¾‹</button>
            
            <div style="text-align: center; color: #8E8E93; font-size: 13px; margin-top: 10px; line-height: 1.5;">
                ğŸ’¡ æç¤ºï¼šæ”¯æŒ AirPodsï¼Œç‚¹å‡»å±å¹•ä»»æ„ä½ç½®ç¿»é¡µ<br>
                ä¸‹æ»‘æ‰“å¼€è®¾ç½®è°ƒæ•´æ»šåŠ¨é€Ÿåº¦
            </div>
        </div>
    </div>

    <!-- æè¯å™¨ç•Œé¢ -->
    <div class="prompter" id="prompter">
        <div class="progress-bar" id="progressBar" style="width: 0%"></div>
        
        <div class="status-bar">
            <div class="status-pill">
                <div class="status-dot" id="statusDot"></div>
                <span id="statusText">å°±ç»ª</span>
            </div>
            <div class="status-pill">
                <span id="progressText">1 / 9</span>
            </div>
        </div>

        <div class="scroll-container" id="scrollContainer">
            <div class="script-wrapper" id="scriptWrapper">
                <!-- åŠ¨æ€ç”Ÿæˆ -->
            </div>
        </div>

        <div class="speed-indicator" id="speedIndicator">é€Ÿåº¦: æ­£å¸¸</div>

        <div class="controls">
            <button class="ctrl-btn small" onclick="adjustSpeed(-1)">ğŸ¢</button>
            <button class="ctrl-btn main" id="micBtn" onclick="toggleVoice()">ğŸ¤</button>
            <button class="ctrl-btn small" onclick="adjustSpeed(1)">ğŸ‡</button>
            <button class="ctrl-btn small" onclick="openSettings()" style="margin-left: 5px;">âš™ï¸</button>
        </div>
    </div>

    <!-- è®¾ç½®é¢æ¿ -->
    <div class="overlay" id="overlay" onclick="closeSettings()"></div>
    <div class="settings-sheet" id="settingsSheet">
        <div class="sheet-header">
            <div class="sheet-title">è®¾ç½®</div>
            <button class="close-btn" onclick="closeSettings()">âœ•</button>
        </div>

        <div class="setting-row">
            <label class="setting-label">æ»šåŠ¨é€Ÿåº¦ï¼ˆè‡ªåŠ¨æ¨¡å¼ï¼‰</label>
            <input type="range" class="ios-slider" min="1" max="5" value="3" id="speedSlider" oninput="updateSpeed(this.value)">
            <div class="speed-labels">
                <span>ææ…¢</span>
                <span>æ…¢</span>
                <span>æ­£å¸¸</span>
                <span>å¿«</span>
                <span>æå¿«</span>
            </div>
        </div>

        <div class="setting-row">
            <button class="ios-btn secondary" onclick="exit()" style="width: 100%;">é€€å‡ºæ¼”è®²</button>
        </div>
    </div>

    <div class="toast" id="toast"></div>

    <script>
        let scriptLines = [];
        let currentIndex = 0;
        let recognition = null;
        let isRecording = false;
        let scrollSpeed = 3; // 1-5
        let autoScrollTimer = null;
        let lineElements = [];
        let lastScrollTime = 0;
        let isAutoScrolling = false;

        // åˆå§‹åŒ–
        function start() {
            const text = document.getElementById('scriptInput').value.trim();
            if (!text) {
                showToast('è¯·è¾“å…¥å°è¯');
                return;
            }

            scriptLines = text.split('\n').filter(l => l.trim());
            document.getElementById('startScreen').classList.add('hidden');
            document.getElementById('prompter').classList.add('active');

            render();
            initVoice();
            
            // iOS å»¶è¿Ÿå¯åŠ¨è¯­éŸ³ï¼Œç¡®ä¿è¿‡æ¸¡åŠ¨ç”»å®Œæˆ
            setTimeout(() => {
                toggleVoice();
            }, 600);

            // é˜²æ­¢ä¼‘çœ 
            preventSleep();
        }

        function loadDemo() {
            const demo = `æ¬¢è¿ä½¿ç”¨ä¸æ»‘æè¯å™¨
è¿™æ˜¯å¹³æ»‘æ»šåŠ¨çš„æ¼”ç¤º
ä½ ä¼šå‘ç°æ–‡å­—åˆ‡æ¢æ—¶
ä¸å†æ˜¯ä¸€è·³ä¸€è·³çš„
è€Œæ˜¯åƒæµæ°´ä¸€æ ·è‡ªç„¶
è¯»å¾—æ…¢ä¼šè‡ªåŠ¨ç­‰ä½ 
è¯»å¾—å¿«ä¼šè¿…é€Ÿè·Ÿä¸Š
è¿™å°±æ˜¯æˆ‘ä»¬è¦çš„ä¸æ»‘
ç¥ä½ æ¼”è®²åœ†æ»¡æˆåŠŸ`;
            document.getElementById('scriptInput').value = demo;
        }

        // æ¸²æŸ“ - ä½¿ç”¨å¹³æ»‘æ»šåŠ¨å®¹å™¨
        function render() {
            const wrapper = document.getElementById('scriptWrapper');
            wrapper.innerHTML = '';
            lineElements = [];

            scriptLines.forEach((line, index) => {
                const div = document.createElement('div');
                div.className = 'script-line';
                div.textContent = line;
                div.dataset.index = index;
                wrapper.appendChild(div);
                lineElements.push(div);
            });

            // åˆå§‹é«˜äº®
            updateActiveLine(0);
        }

        // å¹³æ»‘æ»šåŠ¨åˆ°æŒ‡å®šè¡Œ - æ ¸å¿ƒå‡½æ•°
        function scrollToLine(index, smooth = true) {
            if (index < 0 || index >= scriptLines.length) return;
            
            currentIndex = index;
            const target = lineElements[index];
            
            // ä½¿ç”¨ scrollIntoView å®ç°å¹³æ»‘æ»šåŠ¨åˆ°è§†å£ä¸­å¤®
            target.scrollIntoView({
                behavior: smooth ? 'smooth' : 'auto',
                block: 'center',
                inline: 'nearest'
            });

            updateActiveLine(index);
            updateProgress();
            
            // éœ‡åŠ¨åé¦ˆ
            if (navigator.vibrate) navigator.vibrate(5);
        }

        // æ›´æ–°é«˜äº®çŠ¶æ€
        function updateActiveLine(index) {
            lineElements.forEach((el, i) => {
                el.classList.remove('active', 'prev');
                if (i === index) {
                    el.classList.add('active');
                } else if (i < index) {
                    el.classList.add('prev');
                }
            });
        }

        // æ›´æ–°è¿›åº¦
        function updateProgress() {
            document.getElementById('progressText').textContent = `${currentIndex + 1} / ${scriptLines.length}`;
            const pct = ((currentIndex + 1) / scriptLines.length * 100);
            document.getElementById('progressBar').style.width = pct + '%';
        }

        // ä¸Šä¸€å¥ï¼ˆå¹³æ»‘ï¼‰
        function prev() {
            if (currentIndex > 0) {
                scrollToLine(currentIndex - 1);
            }
        }

        // ä¸‹ä¸€å¥ï¼ˆå¹³æ»‘ï¼‰
        function next() {
            if (currentIndex < scriptLines.length - 1) {
                scrollToLine(currentIndex + 1);
            }
        }

        // é€Ÿåº¦è°ƒèŠ‚
        function adjustSpeed(delta) {
            const newSpeed = Math.max(1, Math.min(5, scrollSpeed + delta));
            if (newSpeed !== scrollSpeed) {
                scrollSpeed = newSpeed;
                updateSpeedIndicator();
                showToast(`é€Ÿåº¦: ${getSpeedText(scrollSpeed)}`);
            }
        }

        function updateSpeed(val) {
            scrollSpeed = parseInt(val);
            updateSpeedIndicator();
        }

        function updateSpeedIndicator() {
            const texts = ['', 'ææ…¢', 'æ…¢', 'æ­£å¸¸', 'å¿«', 'æå¿«'];
            document.getElementById('speedIndicator').textContent = `é€Ÿåº¦: ${texts[scrollSpeed]}`;
            document.getElementById('speedIndicator').classList.add('show');
            setTimeout(() => document.getElementById('speedIndicator').classList.remove('show'), 1500);
        }

        function getSpeedText(s) {
            const texts = {1: 'ææ…¢', 2: 'æ…¢', 3: 'æ­£å¸¸', 4: 'å¿«', 5: 'æå¿«'};
            return texts[s] || 'æ­£å¸¸';
        }

        // è¯­éŸ³è¯†åˆ«ï¼ˆiOS ä¼˜åŒ–ï¼‰
        function initVoice() {
            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            if (!SpeechRecognition) return;

            recognition = new SpeechRecognition();
            recognition.continuous = false; // iOS ä¸æ”¯æŒ true
            recognition.interimResults = true;
            recognition.lang = 'zh-CN';

            let lastResultTime = Date.now();
            let resultCount = 0;

            recognition.onstart = () => {
                isRecording = true;
                document.getElementById('statusDot').classList.add('active');
                document.getElementById('statusText').textContent = 'è†å¬ä¸­';
                document.getElementById('micBtn').classList.add('recording');
                showToast('å¼€å§‹è†å¬');
            };

            recognition.onresult = (event) => {
                const now = Date.now();
                const timeDiff = now - lastResultTime;
                lastResultTime = now;
                resultCount++;

                // è·å–è¯†åˆ«æ–‡æœ¬
                let transcript = '';
                for (let i = event.resultIndex; i < event.results.length; i++) {
                    transcript += event.results[i][0].transcript;
                }

                // æ ¹æ®è¿”å›é¢‘ç‡ä¼°ç®—è¯­é€Ÿï¼ˆæ—¶é—´å·®è¶Šå°è¯´æ˜è¯´å¾—è¶Šå¿«ï¼‰
                checkAndScroll(transcript, timeDiff);
            };

            recognition.onerror = (e) => {
                if (e.error === 'not-allowed') {
                    showToast('è¯·å…è®¸éº¦å…‹é£æƒé™');
                    stopVoice();
                } else if (e.error !== 'no-speech') {
                    console.log(e.error);
                }
            };

            recognition.onend = () => {
                if (isRecording) {
                    // iOS è‡ªåŠ¨é‡å¯ï¼Œä¿æŒè¿ç»­
                    setTimeout(() => {
                        if (isRecording) recognition.start();
                    }, 150);
                }
            };
        }

        // æ™ºèƒ½åŒ¹é…å¹¶æ»šåŠ¨ - æ ¹æ®è¯­é€Ÿè°ƒæ•´
        function checkAndScroll(speech, timeDiff) {
            const speechClean = speech.toLowerCase().replace(/[\s,ï¼Œã€‚ï¼ï¼Ÿ]/g, '');
            
            // åœ¨å½“å‰ä½ç½®åæŸ¥æ‰¾åŒ¹é…
            const searchRange = Math.min(3, scriptLines.length - currentIndex);
            
            for (let i = 1; i <= searchRange; i++) {
                const targetIdx = currentIndex + i;
                if (targetIdx >= scriptLines.length) break;
                
                const line = scriptLines[targetIdx].toLowerCase().replace(/[\s,ï¼Œã€‚ï¼ï¼Ÿ]/g, '');
                
                // åŒ¹é…é€»è¾‘ï¼šå‰4ä¸ªå­—åŒ¹é…å³å¯
                if (line && speechClean.includes(line.substring(0, 4))) {
                    // æ ¹æ®è¯­é€Ÿå†³å®šæ»šåŠ¨å»¶è¿Ÿï¼ˆè¯´å¾—å¿«å°±æ»šå¾—å¿«ï¼‰
                    let delay = 0;
                    if (timeDiff < 500) delay = 0; // è¯´å¾—å¾ˆå¿«ï¼Œç«‹å³æ»šåŠ¨
                    else if (timeDiff < 1000) delay = 200; // æ­£å¸¸é€Ÿåº¦
                    else delay = 400; // è¯´å¾—æ…¢ï¼Œå¤šç­‰ä¸€ä¸‹
                    
                    setTimeout(() => scrollToLine(targetIdx), delay);
                    break;
                }
            }
        }

        function toggleVoice() {
            if (!recognition) {
                showToast('ä¸æ”¯æŒè¯­éŸ³è¯†åˆ«');
                return;
            }
            
            if (isRecording) {
                stopVoice();
            } else {
                recognition.start();
            }
        }

        function stopVoice() {
            isRecording = false;
            try { recognition.stop(); } catch(e) {}
            document.getElementById('statusDot').classList.remove('active');
            document.getElementById('statusText').textContent = 'æš‚åœ';
            document.getElementById('micBtn').classList.remove('recording');
        }

        // è§¦æ‘¸æ§åˆ¶ - ä¼˜åŒ–æ»‘åŠ¨ä½“éªŒ
        let touchStartY = 0;
        let touchStartTime = 0;

        document.getElementById('scrollContainer').addEventListener('touchstart', (e) => {
            touchStartY = e.touches[0].clientY;
            touchStartTime = Date.now();
        }, { passive: true });

        document.getElementById('scrollContainer').addEventListener('touchend', (e) => {
            const touchEndY = e.changedTouches[0].clientY;
            const diff = touchStartY - touchEndY;
            const timeDiff = Date.now() - touchStartTime;
            
            // å¿«é€Ÿæ»‘åŠ¨è¯†åˆ«
            if (Math.abs(diff) > 50 && timeDiff < 300) {
                if (diff > 0) next(); // ä¸Šæ»‘ä¸‹ä¸€å¥
                else prev(); // ä¸‹æ»‘ä¸Šä¸€å¥
            }
        }, { passive: true });

        // ç‚¹å‡»æ§åˆ¶ï¼ˆå¤‡ç”¨ï¼‰
        document.getElementById('scrollContainer').addEventListener('click', (e) => {
            const x = e.clientX;
            if (x < window.innerWidth / 3) prev();
            else if (x > window.innerWidth * 2 / 3) next();
        });

        // é”®ç›˜/è“ç‰™é¥æ§å™¨
        document.addEventListener('keydown', (e) => {
            if (!document.getElementById('prompter').classList.contains('active')) return;
            
            if (e.key === 'ArrowDown' || e.key === ' ' || e.key === 'PageDown') {
                e.preventDefault();
                next();
            } else if (e.key === 'ArrowUp' || e.key === 'PageUp') {
                e.preventDefault();
                prev();
            } else if (e.key === 'Enter') {
                toggleVoice();
            }
        });

        // è®¾ç½®é¢æ¿
        function openSettings() {
            document.getElementById('overlay').classList.add('show');
            document.getElementById('settingsSheet').classList.add('open');
        }

        function closeSettings() {
            document.getElementById('overlay').classList.remove('show');
            document.getElementById('settingsSheet').classList.remove('open');
        }

        function exit() {
            if (confirm('ç¡®å®šé€€å‡ºï¼Ÿ')) {
                stopVoice();
                document.getElementById('prompter').classList.remove('active');
                document.getElementById('startScreen').classList.remove('hidden');
                closeSettings();
            }
        }

        function showToast(msg) {
            const toast = document.getElementById('toast');
            toast.textContent = msg;
            toast.classList.add('show');
            setTimeout(() => toast.classList.remove('show'), 2000);
        }

        function preventSleep() {
            // iOS é˜²ä¼‘çœ ï¼šæ’­æ”¾æ— å£°è§†é¢‘
            const video = document.createElement('video');
            video.src = 'data:video/mp4;base64,AAAAFGZ0eXBpc29tAAACAGlzb21pc28yYXZjMW1wNDEAAAAIZnJlZQAACKBtZGF0AAAC';
            video.loop = true;
            video.playsInline = true;
            video.style.opacity = 0;
            video.style.position = 'absolute';
            video.play().catch(() => {});
        }

        // ç›‘å¬æ‰‹åŠ¨æ»šåŠ¨åœæ­¢ï¼Œæ›´æ–°å½“å‰è¡Œ
        let scrollTimeout;
        document.getElementById('scrollContainer').addEventListener('scroll', () => {
            if (isAutoScrolling) return;
            
            clearTimeout(scrollTimeout);
            scrollTimeout = setTimeout(() => {
                // è®¡ç®—å½“å‰åœ¨ä¸­é—´çš„æ˜¯å“ªä¸€è¡Œ
                const container = document.getElementById('scrollContainer');
                const center = container.scrollTop + container.clientHeight / 2;
                
                let closest = 0;
                let minDist = Infinity;
                
                lineElements.forEach((el, i) => {
                    const rect = el.getBoundingClientRect();
                    const elCenter = rect.top + rect.height / 2;
                    const dist = Math.abs(elCenter - window.innerHeight / 2);
                    
                    if (dist < minDist) {
                        minDist = dist;
                        closest = i;
                    }
                });
                
                if (closest !== currentIndex) {
                    currentIndex = closest;
                    updateActiveLine(closest);
                    updateProgress();
                }
            }, 150);
        }, { passive: true });
    </script>
</body>
</html>
