<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>专业提词器</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
            user-select: none;
        }

        :root {
            --font-size: 36px;
            --line-height: 1.6;
            --scroll-speed: 1.0;
        }

        html, body {
            width: 100%;
            height: 100%;
            background: #000;
            color: #fff;
            font-family: -apple-system, BlinkMacSystemFont, "SF Pro Display", sans-serif;
            overflow: hidden;
        }

        /* 启动页 */
        .start {
            position: fixed;
            inset: 0;
            background: #000;
            padding: 40px 30px;
            z-index: 1000;
            display: flex;
            flex-direction: column;
        }

        .start.hidden { display: none; }

        h1 {
            font-size: 28px;
            font-weight: 600;
            margin-bottom: 8px;
            color: #fff;
        }

        .sub {
            color: #666;
            font-size: 15px;
            margin-bottom: 30px;
        }

        textarea {
            width: 100%;
            flex: 1;
            background: #111;
            border: 1px solid #333;
            border-radius: 12px;
            padding: 20px;
            color: #fff;
            font-size: 16px;
            line-height: 1.5;
            resize: none;
            margin-bottom: 15px;
            -webkit-user-select: text;
        }

        .btn {
            width: 100%;
            padding: 16px;
            background: #fff;
            color: #000;
            border: none;
            border-radius: 12px;
            font-size: 17px;
            font-weight: 600;
            cursor: pointer;
        }

        /* 提词器主体 - 全屏纯净 */
        .prompter {
            display: none;
            position: fixed;
            inset: 0;
            background: #000;
            overflow: hidden;
        }

        .prompter.active {
            display: block;
        }

        /* 滚动轨道 - 匀速滚动核心 */
        .track {
            position: absolute;
            width: 100%;
            padding: 0 40px;
            top: 0;
            left: 0;
            will-change: transform;
        }

        .line {
            width: 100%;
            text-align: center;
            font-size: var(--font-size);
            line-height: var(--line-height);
            color: rgba(255, 255, 255, 0.4); /* 统一浅白色，不黑 */
            padding: 0;
            margin: 0;
            font-weight: 400;
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: calc(var(--font-size) * var(--line-height));
            transition: all 0.3s ease;
        }

        /* 只有当前行高亮 - 不改变其他行颜色 */
        .line.active {
            color: #fff;
            font-weight: 600;
            text-shadow: 0 0 20px rgba(255,255,255,0.2);
        }

        /* 全屏时彻底隐藏的UI */
        .ui-top {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            padding: 15px 20px;
            padding-top: env(safe-area-inset-top);
            display: flex;
            justify-content: space-between;
            z-index: 100;
            opacity: 0;
            transition: opacity 0.3s;
            pointer-events: none;
        }

        .ui-top.show {
            opacity: 1;
            pointer-events: auto;
        }

        .pill {
            background: rgba(50,50,50,0.8);
            backdrop-filter: blur(10px);
            padding: 6px 12px;
            border-radius: 16px;
            font-size: 12px;
            color: #999;
        }

        .pill.recording {
            color: #30D158;
        }

        /* 设置按钮 - 角落最小化 */
        .settings-trigger {
            position: absolute;
            top: env(safe-area-inset-top, 10px);
            right: 10px;
            width: 40px;
            height: 40px;
            background: transparent;
            border: none;
            color: rgba(255,255,255,0.3);
            font-size: 20px;
            z-index: 200;
            opacity: 0;
            transition: opacity 0.3s;
        }

        .settings-trigger.show {
            opacity: 1;
        }

        /* 底部滑块 - 临时调出 */
        .controls {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            padding: 20px;
            padding-bottom: env(safe-area-inset-bottom, 20px);
            background: linear-gradient(to top, rgba(0,0,0,0.9), transparent);
            z-index: 100;
            opacity: 0;
            transition: opacity 0.3s;
            pointer-events: none;
        }

        .controls.show {
            opacity: 1;
            pointer-events: auto;
        }

        .speed-control {
            display: flex;
            align-items: center;
            gap: 15px;
            color: #666;
            font-size: 13px;
        }

        .slider {
            flex: 1;
            -webkit-appearance: none;
            height: 4px;
            border-radius: 2px;
            background: rgba(255,255,255,0.2);
            outline: none;
        }

        .slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: #fff;
            cursor: pointer;
        }

        /* 设置面板 */
        .settings {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: rgba(20,20,20,0.98);
            border-radius: 20px 20px 0 0;
            padding: 25px;
            padding-bottom: env(safe-area-inset-bottom, 25px);
            transform: translateY(100%);
            transition: transform 0.3s;
            z-index: 300;
        }

        .settings.open {
            transform: translateY(0);
        }

        .setting-row {
            margin-bottom: 25px;
        }

        .label {
            display: flex;
            justify-content: space-between;
            font-size: 14px;
            color: #666;
            margin-bottom: 10px;
        }

        .value {
            color: #fff;
        }

        .btn-close {
            width: 100%;
            padding: 15px;
            background: #333;
            border: none;
            border-radius: 12px;
            color: #fff;
            font-size: 16px;
            margin-top: 10px;
        }

        .overlay {
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.5);
            opacity: 0;
            pointer-events: none;
            z-index: 250;
        }

        .overlay.show {
            opacity: 1;
            pointer-events: auto;
        }

        /* 全屏时强制隐藏所有系统UI */
        :fullscreen .ui-top,
        :webkit-full-screen .ui-top {
            display: none !important;
        }
    </style>
</head>
<body>

    <!-- 启动页 -->
    <div class="start" id="start">
        <h1>专业提词器</h1>
        <div class="sub">匀速滚动 · 预判翻页 · 纯净全屏</div>
        <textarea id="input" placeholder="粘贴台词，每行一句...">欢迎使用专业提词器
文字会匀速向上滚动
只有当前行是高亮白色
其他行是浅灰色不会变黑
滚动速度恒定可调
不会因为语速忽快忽慢
全屏时没有任何色块遮挡
点击屏幕显示设置
祝你演讲成功</textarea>
        <button class="btn" onclick="start()">开始演讲</button>
    </div>

    <!-- 提词器 -->
    <div class="prompter" id="prompter">
        <!-- 极简状态栏 - 默认隐藏 -->
        <div class="ui-top" id="uiTop">
            <div class="pill" id="statusPill">就绪</div>
            <div class="pill" id="progressPill">1/10</div>
        </div>

        <!-- 设置触发区 -->
        <button class="settings-trigger" id="trigger" onclick="toggleUI()">⚙️</button>

        <!-- 滚动轨道 -->
        <div class="track" id="track"></div>

        <!-- 底部控制 -->
        <div class="controls" id="controls">
            <div class="speed-control">
                <span>慢</span>
                <input type="range" class="slider" min="0.5" max="2.0" step="0.1" value="1.0" id="speedSlider" oninput="setSpeed(this.value)">
                <span>快</span>
            </div>
        </div>

        <!-- 设置面板 -->
        <div class="overlay" id="overlay" onclick="closeSettings()"></div>
        <div class="settings" id="settings">
            <div class="setting-row">
                <div class="label">
                    <span>字体大小</span>
                    <span class="value" id="fontVal">36px</span>
                </div>
                <input type="range" class="slider" min="24" max="60" value="36" oninput="setFont(this.value)">
            </div>
            <div class="setting-row">
                <div class="label">
                    <span>行间距</span>
                    <span class="value" id="lineVal">1.6</span>
                </div>
                <input type="range" class="slider" min="12" max="24" value="16" oninput="setLine(this.value)">
            </div>
            <button class="btn-close" onclick="exit()">退出演讲</button>
        </div>
    </div>

    <script>
        let lines = [];
        let lineEls = [];
        let current = 0;
        let offset = 0;
        let target = 0;
        let speed = 1.0;
        let autoScroll = null;
        let recognition = null;
        let isRecording = false;
        let heights = [];
        let cumulative = [];
        let uiVisible = false;

        function start() {
            const text = document.getElementById('input').value.trim();
            if (!text) return alert('请输入台词');
            
            lines = text.split('\n').filter(l => l.trim());
            document.getElementById('start').classList.add('hidden');
            document.getElementById('prompter').classList.add('active');
            
            init();
            requestFullscreen();
            
            // 延迟启动，等全屏完成
            setTimeout(() => {
                startScroll();
                initVoice();
            }, 300);
        }

        function init() {
            const track = document.getElementById('track');
            track.innerHTML = '';
            lineEls = [];
            
            lines.forEach((line, i) => {
                const div = document.createElement('div');
                div.className = 'line';
                div.textContent = line;
                track.appendChild(div);
                lineEls.push(div);
            });

            // 计算高度
            setTimeout(() => {
                let sum = 0;
                heights = [];
                cumulative = [];
                lineEls.forEach(el => {
                    const h = el.offsetHeight;
                    heights.push(h);
                    cumulative.push(sum);
                    sum += h;
                });
                
                // 初始位置：第一行在视线位置（屏幕下方1/3处）
                const viewport = window.innerHeight;
                const focus = viewport * 0.6;
                offset = focus - heights[0]/2;
                target = offset;
                track.style.transform = `translateY(${offset}px)`;
                updateActive(0);
            }, 50);
        }

        // 匀速滚动核心
        function startScroll() {
            if (autoScroll) cancelAnimationFrame(autoScroll);
            
            function animate() {
                // 匀速接近目标
                const diff = target - offset;
                if (Math.abs(diff) > 0.5) {
                    // 恒定速度，不根据语速变化
                    const step = Math.min(Math.abs(diff) * 0.05 * speed, 3 * speed);
                    offset += diff > 0 ? step : -step;
                    document.getElementById('track').style.transform = `translateY(${offset}px)`;
                }
                autoScroll = requestAnimationFrame(animate);
            }
            animate();
        }

        function goTo(index) {
            if (index < 0 || index >= lines.length) return;
            const viewport = window.innerHeight;
            const focus = viewport * 0.6;
            target = focus - (cumulative[index] + heights[index]/2);
            updateActive(index);
            updateProgress(index);
            current = index;
        }

        function updateActive(index) {
            lineEls.forEach((el, i) => {
                el.classList.toggle('active', i === index);
            });
        }

        function updateProgress(index) {
            document.getElementById('progressPill').textContent = `${index + 1}/${lines.length}`;
        }

        // 预判翻页 - 检测读完前几个字就开始滚动
        function checkSpeech(text) {
            text = text.toLowerCase().replace(/\s/g, '');
            const currentText = lines[current].toLowerCase().replace(/\s/g, '');
            
            // 预判：匹配到当前行后4个字，说明快读完了
            if (currentText.length > 4 && text.includes(currentText.slice(-4))) {
                if (current < lines.length - 1) {
                    // 提前滚动，给用户看下一行的时间
                    setTimeout(() => next(), 200);
                }
            }
            
            // 如果直接跳到下一行开头，立即跟上
            if (current < lines.length - 1) {
                const nextText = lines[current + 1].toLowerCase().replace(/\s/g, '');
                if (nextText.length > 3 && text.includes(nextText.slice(0, 3))) {
                    next();
                }
            }
        }

        function next() {
            if (current < lines.length - 1) goTo(current + 1);
        }

        function prev() {
            if (current > 0) goTo(current - 1);
        }

        // 速度设置 - 恒定不变，不自动调节
        function setSpeed(val) {
            speed = parseFloat(val);
        }

        function setFont(val) {
            document.documentElement.style.setProperty('--font-size', val + 'px');
            document.getElementById('fontVal').textContent = val + 'px';
            // 重新计算
            setTimeout(() => {
                let sum = 0;
                cumulative = [];
                lineEls.forEach(el => {
                    const h = el.offsetHeight;
                    heights.push(h);
                    cumulative.push(sum);
                    sum += h;
                });
                goTo(current);
            }, 100);
        }

        function setLine(val) {
            const lh = val / 10;
            document.documentElement.style.setProperty('--line-height', lh);
            document.getElementById('lineVal').textContent = lh.toFixed(1);
            setTimeout(() => {
                let sum = 0;
                cumulative = [];
                lineEls.forEach((el, i) => {
                    const h = el.offsetHeight;
                    heights[i] = h;
                    cumulative.push(sum);
                    sum += h;
                });
                goTo(current);
            }, 100);
        }

        // UI控制
        function toggleUI() {
            uiVisible = !uiVisible;
            document.getElementById('uiTop').classList.toggle('show', uiVisible);
            document.getElementById('controls').classList.toggle('show', uiVisible);
            document.getElementById('trigger').classList.toggle('show', !uiVisible);
        }

        // 点击屏幕控制
        let lastTap = 0;
        document.getElementById('prompter').addEventListener('click', (e) => {
            const now = Date.now();
            const x = e.clientX;
            const w = window.innerWidth;
            
            if (now - lastTap < 300) {
                // 双击打开设置
                openSettings();
            } else if (x < w * 0.25) {
                prev();
            } else if (x > w * 0.75) {
                next();
            } else if (!uiVisible) {
                toggleUI();
            }
            
            lastTap = now;
        });

        function openSettings() {
            document.getElementById('overlay').classList.add('show');
            document.getElementById('settings').classList.add('open');
        }

        function closeSettings() {
            document.getElementById('overlay').classList.remove('show');
            document.getElementById('settings').classList.remove('open');
        }

        function exit() {
            if (confirm('退出？')) {
                if (document.exitFullscreen) document.exitFullscreen();
                location.reload();
            }
        }

        // 语音识别
        function initVoice() {
            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            if (!SpeechRecognition) return;

            recognition = new SpeechRecognition();
            recognition.continuous = false;
            recognition.interimResults = true;
            recognition.lang = 'zh-CN';

            recognition.onstart = () => {
                isRecording = true;
                document.getElementById('statusPill').textContent = '● 录音';
                document.getElementById('statusPill').classList.add('recording');
            };

            recognition.onresult = (e) => {
                let transcript = '';
                for (let i = e.resultIndex; i < e.results.length; i++) {
                    transcript += e.results[i][0].transcript;
                }
                checkSpeech(transcript);
            };

            recognition.onend = () => {
                if (isRecording) setTimeout(() => recognition.start(), 100);
            };

            recognition.start();
        }

        function requestFullscreen() {
            const el = document.documentElement;
            if (el.requestFullscreen) el.requestFullscreen();
            else if (el.webkitRequestFullscreen) el.webkitRequestFullscreen();
        }

        // 键盘控制
        document.addEventListener('keydown', (e) => {
            if (e.key === 'ArrowDown' || e.key === ' ') next();
            if (e.key === 'ArrowUp') prev();
            if (e.key === 'f') requestFullscreen();
        });
    </script>
</body>
</html>
